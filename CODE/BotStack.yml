Description: CF Stack for the Penny Discord Bot Deployment

Parameters:
  BotToken:
    Type: String
    Description: The private token of the Penny-Bot
  ApiGatewayEndpoint:
    Type: String
    Description: The endpoint url of the api gateway
  RepositoryName:
    Type: String
    Description: The name of the ECR repository
    Default: penny-bot-discord-image

Resources:
  botAppRunner:
    Type: AWS::AppRunner::Service
    Properties:
      ServiceName: Penny-Bot
      SourceConfiguration:
        AuthenticationConfiguration:
          AccessRoleArn: arn:aws:iam::177420307256:role/service-role/PennyBotAppRunner
        AutoDeploymentsEnabled: true
        ImageRepository:
          #ImageIdentifier: !GetAtt botECRRepository.RepositoryUri
          ImageIdentifier: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${RepositoryName}:latest
          ImageRepositoryType: ECR
          ImageConfiguration:
            RuntimeEnvironmentVariables:
              - 
                Name: BOT_TOKEN
                Value: !Sub ${BotToken}
              - 
                Name: API_BASE_URL
                Value: !Sub ${ApiGatewayEndpoint}
    DependsOn: botECRRepository
  
  botECRRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub ${RepositoryName}